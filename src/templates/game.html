<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twordle-Dee</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/cdn/stylesheets/bootstrap.css">

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>


    <style>
        .letter-block {
            width: min(15vw, 75px);
            height: min(15vw, 75px);
            display: inline-block;
            vertical-align: middle;
        }

        .bg-green {
            background-color: #198754;
            color: white;

        }

        .bg-gray {
            background-color: #212529;
            color: white;

        }

        .bg-yellow {
            background-color: #ffc107;
            color: black;
        }

        .timer {
            color: #ffffff;
            background-color: #333;
            font-size: 36px;
            /* padding: 10px 20px; */
            text-shadow: 0 1px 0 white;
            /* //border-radius: 10%; */
        }

        .pausebutton {
            color: #ffffff;
            background-color: #335;
            font-size: 36px;
            /* padding: 10px 20px; */
            text-shadow: 0 1px 0 white;
            /* //border-radius: 10%; */
        }

        .hide {
            display: none;
        }

        .myDIV:hover+.hide {
            display: block;
            color: red;
        }

        #mouse_over {
            opacity: 0;
        }

        #mouse_over:hover {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="d-flex justify-content-center mt-1">
        <div>
            <button type="button" id="pauseTimer" class="btn btn-light mt-1" onclick="pauseTimer()"><span id="timer"></span></button>
        </div>
    </div>

    <div>
        <p id="response"></p>
        <div class="input-group">
            <input id="guess" type="hidden" class="form-control" placeholder="Guess" autofocus
                oninput="syncRow(document.getElementById('guess').value)">
            <!-- <div class="input-group-append" id="Guess Button Location">
                <button class="btn btn-outline-secondary" type="button" onclick="makeGuess()"
                    id="submit Guess">Guess</button>
            </div> -->
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Game Over</h5>
                </div>
                <div class="modal-body" id="Game Result">
                    ...
                </div>
                <div class="modal-footer">
                    <a href="game" class="btn btn-primary" role="button">Play Another Game</a>
                    <a href="/" class="btn btn-primary" role="button">Home</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid text-center">
        <div class="row" id="boards">

        </div>
    </div>





    <script>
        let game = 0;

        let sendGuess = async (guess) => {
            let headers = new Headers();
            headers.append("Content-Type", "application/json");

            let raw = JSON.stringify({
                "guess": guess,
                "game": game
            });

            let requestOptions = {
                method: 'POST',
                headers: headers,
                body: raw,
                redirect: 'follow'
            };
            const response = await fetch("api/guess", requestOptions)
            return response.json()
        }

        guesses = 0
        let i = 0
        let score = 0;
        let calculateScore = (data, wordNumber) => {
            let multiplier = 5 - wordNumber
            let array = data.colour
            try {
                for (let index = 0; index < array.length; index++) {
                    const element = array[index];
                    if (element == "green") {
                        score = score + multiplier * 2
                    }
                    else if (element == "yellow") {
                        score = score + multiplier
                    }
                }
            } catch (error) {
                console.log(error)
            }
        }

        let makeGuess = () => {
            let guess = document.getElementById('guess').value
            let message = document.getElementById('response')
            sendGuess(guess)
                .then(data => {
                    if (data.code === "ok") {
                        message.classList.remove('text-danger')
                        message.innerHTML = ''
                        generateColouredGuess(guess, data.colour)

                        calculateScore(data, i)
                        updateKeyboardColour(guess, data.colour)
                        let f = 0

                        data.colour.forEach(function (element) {
                            if (element != 'green') f = 1
                        })

                        if (f === 0) {
                            gameEnd(2)
                        }

                        i += 1
                        if (i === 6) { const y = document.getElementById('buttonEnter'); y.click() }
                    } else {
                        message.classList.add('text-danger')
                        message.innerHTML = data.message
                    }
                })
                .catch(error => {
                    console.error(error)
                    message.classList.add('text-danger')
                    message.innerHTML = "Invalid Input"
                    const y = document.getElementById('submit Guess')
                    if (y.innerHTML === 'complete' || i === 6) { message.innerHTML = '' }
                })


            if (i == 4) {
                gameEnd(1)
            }

        }

        let gameEnd = function (i) {
            if (i === 1) {   //When player tuns out of guesses
                let headers = new Headers();
                headers.append("Content-Type", "application/json");
                let raw = JSON.stringify({
                    "game": game
                });
                let requestOptions = {
                    method: 'POST',
                    headers: headers,
                    body: raw,
                    redirect: 'follow'
                };
                fetch('api/correct', requestOptions)
                    .then(function (response) {
                        if (response.ok) { return response.json() } // Return the response parse as JSON
                        else { throw 'Failed to load correct word: response code invalid!' }
                    })

                    .then(function (data) {
                        const x = document.getElementById('Game Result')
                        x.innerHTML = `The correct word was ${data.word}. You achieved a score of: ` + score
                    })

                    .catch(function (e) { // Process error for request
                        alert(e) // Displays a browser alert with the error message.
                    })

                const y = document.getElementById('buttonEnter')
                y.setAttribute('data-bs-toggle', 'modal')
                y.setAttribute('data-bs-target', '#staticBackdrop')

            }

            if (i === 2) {   //When player guesses word correctly
                const x = document.getElementById('Game Result')
                x.innerHTML = `You Guessed the word correctly. You achieved a score of: ` + score
                const y = document.getElementById('buttonEnter')
                y.setAttribute('data-bs-toggle', 'modal')
                y.setAttribute('data-bs-target', '#staticBackdrop')
                y.click()
            }

            if (i === 3) {
                // For time limit
            }
        }
        // export {gameEnd}

        let generateColouredGuess = (guess, colours) => {
            let out = document.createElement("div")
            out.classList.add(['pb-1'])

            guess = guess.toUpperCase()

            for (let character = 0; character < colours.length; character++) {
                document.getElementById('blockrow' + guesses + 'character' + character).classList.add('bg-' + colours[character], 'm-1')
                document.getElementById('row' + guesses + 'character' + character).innerHTML = guess.charAt(character)
            }

            guesses++
            document.getElementById('guess').value = ''
        }

        let newGame = () => {
            fetch('api/game')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'ok') {
                        game = data.game
                    }
                    else {

                        console.log('Cannot create new game')
                    }
                })

        }

        let gameIsValid = () => {
            return i <= 5
        }

        window.onload = () => {
            document.getElementById('guess').addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {

                    if (gameIsValid()) makeGuess()
                    document.getElementById('guess').focus()
                }
            })
            initBoards(1)

            // request a new game ID 
            newGame()
        }

        let initBoards = function (count) {
            for (let i = 0; i < count; i++) {
                let board = document.createElement("div")
                board.classList.add('col-xl', 'pb-2')
                board.id = 'board' + i
                for (let row = 0; row < 6; row++) {
                    let line = document.createElement("div")
                    line.classList.add(['pb-1'])
                    for (let character = 0; character < 5; character++) {
                        let block = document.createElement("div")
                        block.classList.add('card', 'card-body', 'letter-block', 'm-1')
                        let letter = document.createElement("h1")
                        letter.id = 'row' + row + 'character' + character
                        block.id = 'blockrow' + row + 'character' + character
                        let letterContainer = document.createElement("div")
                        letterContainer.classList.add('d-inline-flex', 'h-100', 'w-100', 'align-items-center', 'justify-content-center')
                        letterContainer.appendChild(letter)
                        block.appendChild(letterContainer)
                        line.appendChild(block)
                    }
                    board.appendChild(line)
                }
                document.getElementById("boards").appendChild(board)
            }
        }

        let syncRow = function (guess) {
            if (guess.length > 5) {
                guess = guess.substring(0, 5)
                document.getElementById('guess').value = guess
            }
            for (let character = 0; character < guess.length; character++) {
                document.getElementById('row' + guesses + 'character' + character).innerHTML = guess.charAt(character).toUpperCase()
            }
            for (let character = guess.length; character < 5; character++) {
                document.getElementById('row' + guesses + 'character' + character).innerHTML = ''
            }
        }

        document.onkeypress = function (e) {
            e = e || window.event;
            var charCode = (typeof e.which == "number") ? e.which : e.keyCode;
            if ((charCode >= 65 && charCode <= 90) || (charCode >= 97 && charCode <= 122)) {
                functionToExecute(String.fromCharCode(charCode))
            }
            else if (charCode === 13) {
                makeGuess()
            }
            else if (charCode === 8) {
                removeLetter()
            }
        }


    </script>

    <div class="container-sm">


        <div class="btn-toolbar mb-1 justify-content-center" role="toolbar">
            <div class="btn-group" role="group" aria-label="First group">
                <button type="button" id="buttonQ" class="btn btn-secondary rounded me-1 keyboard-block"
                    onclick="functionToExecute('q')">Q</button>
                <button type="button" id="buttonW" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('w')">W</button>
                <button type="button" id="buttonE" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('e')">E</button>
                <button type="button" id="buttonR" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('r')">R</button>
                <button type="button" id="buttonT" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('t')">T</button>
                <button type="button" id="buttonY" class="btn btn-secondary rounded me-1 "
                    onclick="functionToExecute('y')">Y</button>
                <button type="button" id="buttonU" class="btn btn-secondary rounded me-1 "
                    onclick="functionToExecute('u')">U</button>
                <button type="button" id="buttonI" class="btn btn-secondary rounded me-1 "
                    onclick="functionToExecute('i')">I</button>
                <button type="button" id="buttonO" class="btn btn-secondary rounded me-1 "
                    onclick="functionToExecute('o')">O</button>
                <button type="button" id="buttonP" class="btn btn-secondary rounded"
                    onclick="functionToExecute('p')">P</button>
            </div>
        </div>


        <div class="btn-toolbar mb-1 justify-content-center" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group" role="group" aria-label="First group">
                <button type="button" id="buttonA" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('a')">A</button>
                <button type="button" id="buttonS" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('s')">S</button>
                <button type="button" id="buttonD" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('d')">D</button>
                <button type="button" id="buttonF" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('f')">F</button>
                <button type="button" id="buttonG" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('g')">G</button>
                <button type="button" id="buttonH" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('h')">H</button>
                <button type="button" id="buttonJ" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('j')">J</button>
                <button type="button" id="buttonK" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('k')">K</button>
                <button type="button" id="buttonL" class="btn btn-secondary rounded"
                    onclick="functionToExecute('l')">L</button>
            </div>
        </div>

        <div class="btn-toolbar mb-1 justify-content-center" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group" role="group" aria-label="First group">
                <button type="button" id="buttonEnter" class="btn btn-secondary rounded me-1"
                    onclick="makeGuess()">&#8594;</button>
                <button type="button" id="buttonA" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('z')">Z</button>
                <button type="button" id="buttonX" class="btn btn-secondary rounded me-1 "
                    onclick="functionToExecute('x')">X</button>
                <button type="button" id="buttonC" class="btn btn-secondary rounded me-1 "
                    onclick="functionToExecute('c')">C</button>
                <button type="button" id="buttonV" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('v')">V</button>
                <button type="button" id="buttonB" class="btn btn-secondary rounded me-1 "
                    onclick="functionToExecute('b')">B</button>
                <button type="button" id="buttonN" class="btn btn-secondary rounded me-1 "
                    onclick="functionToExecute('n')">N</button>
                <button type="button" id="buttonM" class="btn btn-secondary rounded me-1"
                    onclick="functionToExecute('m')">M</button>
                <button type="button" class="btn btn-secondary rounded" onclick="removeLetter()"> &#60;- </button>
            </div>
        </div>
    </div>

    <script src="/cdn/scripts/keyboardLogger.js"></script>
    <script src="/cdn/scripts/timer.js"></script>
</body>

</html>